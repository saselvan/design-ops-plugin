#!/bin/bash
# pre-commit hook - Validates staged spec files against invariants
#
# Installation:
#   cp this-file .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or run: ./enforcement/docs/git-hooks/install.sh
#
# Skip (emergency): git commit --no-verify

set -e

# Find repo root and validator
REPO_ROOT=$(git rev-parse --show-toplevel)
VALIDATOR="$REPO_ROOT/enforcement/validator.sh"

# Check if validator exists
if [ ! -f "$VALIDATOR" ]; then
    echo "Warning: Validator not found at $VALIDATOR"
    echo "Skipping spec validation"
    exit 0
fi

# Make sure validator is executable
chmod +x "$VALIDATOR" 2>/dev/null || true

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Get staged spec files
STAGED_SPECS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md)$' | grep -E '^(specs|prp)/' || true)

if [ -z "$STAGED_SPECS" ]; then
    # No spec files staged, allow commit
    exit 0
fi

echo ""
echo -e "${GREEN}Validating staged spec files...${NC}"
echo ""

TOTAL_VIOLATIONS=0
TOTAL_WARNINGS=0
FAILED_FILES=""

for spec in $STAGED_SPECS; do
    # Validate against staged version, not working directory
    TEMP_FILE=$(mktemp)
    git show ":$spec" > "$TEMP_FILE" 2>/dev/null || continue

    echo "Checking: $spec"

    # Run validator
    set +e
    OUTPUT=$("$VALIDATOR" "$TEMP_FILE" 2>&1)
    EXIT_CODE=$?
    set -e

    # Clean up temp file
    rm -f "$TEMP_FILE"

    # Count issues
    VIOLATIONS=$(echo "$OUTPUT" | grep -c "VIOLATION:" || true)
    WARNINGS=$(echo "$OUTPUT" | grep -c "WARNING:" || true)

    TOTAL_VIOLATIONS=$((TOTAL_VIOLATIONS + VIOLATIONS))
    TOTAL_WARNINGS=$((TOTAL_WARNINGS + WARNINGS))

    if [ $EXIT_CODE -ne 0 ]; then
        FAILED_FILES="$FAILED_FILES\n  - $spec"
        # Show violations for this file
        echo "$OUTPUT" | grep -A2 "VIOLATION:" || true
    elif [ $WARNINGS -gt 0 ]; then
        echo -e "  ${YELLOW}$WARNINGS warning(s)${NC}"
    else
        echo -e "  ${GREEN}OK${NC}"
    fi
done

echo ""
echo "=========================================="

if [ $TOTAL_VIOLATIONS -gt 0 ]; then
    echo -e "${RED}COMMIT BLOCKED${NC}"
    echo ""
    echo -e "Found ${RED}$TOTAL_VIOLATIONS violation(s)${NC} in:"
    echo -e "$FAILED_FILES"
    echo ""
    echo "Fix violations before committing."
    echo "Run: ./enforcement/validator.sh <spec>.md"
    echo ""
    echo "To bypass (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
elif [ $TOTAL_WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}COMMIT ALLOWED${NC} (with $TOTAL_WARNINGS warning(s))"
    echo ""
    echo "Consider addressing warnings before production."
    exit 0
else
    echo -e "${GREEN}COMMIT ALLOWED${NC} - All specs valid"
    exit 0
fi
